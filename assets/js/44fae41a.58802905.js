"use strict";(self.webpackChunkcot_docs=self.webpackChunkcot_docs||[]).push([[817],{8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>c});var t=r(6540);const i={},s=t.createContext(i);function o(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(s.Provider,{value:n},e.children)}},9249:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"system-architecture/nginx","title":"NGINX","description":"In our server. The default nginx configuration can be found here","source":"@site/docs/system-architecture/3_nginx.md","sourceDirName":"system-architecture","slug":"/system-architecture/nginx","permalink":"/cot-documentation/docs/system-architecture/nginx","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/system-architecture/3_nginx.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"PM2","permalink":"/cot-documentation/docs/system-architecture/pm2"},"next":{"title":"MySQL","permalink":"/cot-documentation/docs/system-architecture/mysql"}}');var i=r(4848),s=r(8453);const o={},c="NGINX",d={},l=[{value:"Overview",id:"overview",level:2},{value:"Configuration Details",id:"configuration-details",level:2},{value:"Server Block (HTTPS - Port 443)",id:"server-block-https---port-443",level:3},{value:"API Reverse Proxy Settings",id:"api-reverse-proxy-settings",level:3},{value:"Static File Caching",id:"static-file-caching",level:3},{value:"SSL Configuration (Managed by Certbot)",id:"ssl-configuration-managed-by-certbot",level:3},{value:"HTTP to HTTPS Redirect (Port 80)",id:"http-to-https-redirect-port-80",level:3},{value:"Usage",id:"usage",level:2},{value:"Starting Nginx",id:"starting-nginx",level:3},{value:"Checking Configuration Validity",id:"checking-configuration-validity",level:3},{value:"Updating SSL Certificates",id:"updating-ssl-certificates",level:3},{value:"Current NGINX Configuration",id:"current-nginx-configuration",level:2},{value:"Conclusion",id:"conclusion",level:2}];function a(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"nginx",children:"NGINX"})}),"\n",(0,i.jsxs)(n.admonition,{type:"info",children:[(0,i.jsx)(n.p,{children:"In our server. The default nginx configuration can be found here"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"cd /etc/nginx/sites-available\r\nnano default\n"})}),(0,i.jsx)(n.p,{children:"Using nano you can modify the configuration"})]}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"This Nginx configuration is set up to serve multiple applications under different locations. It handles API requests, WebSocket connections, static file hosting, and reverse proxying for both production and test environments. Additionally, it includes SSL settings managed by Certbot."}),"\n",(0,i.jsx)(n.h2,{id:"configuration-details",children:"Configuration Details"}),"\n",(0,i.jsx)(n.h3,{id:"server-block-https---port-443",children:"Server Block (HTTPS - Port 443)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Domain: ",(0,i.jsx)(n.code,{children:"recruitment.connextglobal.com"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"SSL Enabled: Managed by Certbot"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Reverse Proxy for APIs:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/api"})," \u2192 ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3001",children:"http://127.0.0.1:3001"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/apiex"})," \u2192 ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3002",children:"http://127.0.0.1:3002"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["WebSocket Handling: - /socket.io \u2192 ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3001",children:"http://127.0.0.1:3001"})," - /socketex \u2192 ",(0,i.jsx)(n.a,{href:"http://127.0.0.1:3002",children:"http://127.0.0.1:3002"})]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"We don't use websockets anymore but just to note we can also proxy it using nginx"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Static File Hosting: - ",(0,i.jsx)(n.code,{children:"/directory"})," serves files from /home/ubuntu/directory/recruitment-system"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/"})," serves files from /home/ubuntu/recruitment-system/client/dist"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/experimental"})," serves files from /home/ubuntu/test/recruitment-system/client/dist"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"/community"})," serves files from /home/ubuntu/test/recruitment-system/client-community/dist"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["We don't use ",(0,i.jsx)(n.code,{children:"/community"})," anymore. This was used for applicant login but the development of this has been halted"]})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"api-reverse-proxy-settings",children:"API Reverse Proxy Settings"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"Each API endpoint is proxied with:"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_http_version 1.1"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_set_header Upgrade $http_upgrade"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_set_header Connection 'upgrade'"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_set_header Host $host"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_cache_bypass $http_upgrade"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_set_header X-Forwarded-Proto $scheme"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"static-file-caching",children:"Static File Caching"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["All static assets (",(0,i.jsx)(n.code,{children:".js, .css, .png, .jpg, .jpeg, .gif, .ico, .svg"}),") have a cache expiration of 30 days."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Cache-control headers ensure efficient browser caching while preventing unnecessary reloads."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ssl-configuration-managed-by-certbot",children:"SSL Configuration (Managed by Certbot)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"SSL certificates are stored at:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"/etc/letsencrypt/live/recruitment.connextglobal.com/fullchain.pem"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"/etc/letsencrypt/live/recruitment.connextglobal.com/privkey.pem"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Uses recommended SSL settings from Certbot (",(0,i.jsx)(n.code,{children:"/etc/letsencrypt/options-ssl-nginx.conf"})," and ",(0,i.jsx)(n.code,{children:"ssl-dhparams.pem"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"http-to-https-redirect-port-80",children:"HTTP to HTTPS Redirect (Port 80)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Redirects all traffic from HTTP to HTTPS (",(0,i.jsx)(n.code,{children:"return 301 https://$host$request_uri"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["If the request does not match the domain, it returns a ",(0,i.jsx)(n.code,{children:"404"})," response."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsx)(n.h3,{id:"starting-nginx",children:"Starting Nginx"}),"\n",(0,i.jsx)(n.p,{children:"To apply the configuration, restart Nginx:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo systemctl restart nginx\n"})}),"\n",(0,i.jsx)(n.h3,{id:"checking-configuration-validity",children:"Checking Configuration Validity"}),"\n",(0,i.jsx)(n.p,{children:"Before restarting, test the configuration for errors:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo nginx -t\n"})}),"\n",(0,i.jsx)(n.h3,{id:"updating-ssl-certificates",children:"Updating SSL Certificates"}),"\n",(0,i.jsx)(n.p,{children:"To renew SSL certificates manually:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo certbot renew --dry-run\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"info",children:[(0,i.jsx)(n.p,{children:"In our server we have a cron for this just follow these steps:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo su\r\ncrontab -e\n"})})]}),"\n",(0,i.jsx)(n.h2,{id:"current-nginx-configuration",children:"Current NGINX Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'\r\n\r\nserver {\r\n\tserver_name recruitment.connextglobal.com;\r\n\tclient_max_body_size 500M;\r\n\tlocation /api {\r\n\t\tproxy_pass http://127.0.0.1:3001;\r\n\t\tproxy_http_version 1.1;\r\n\t\tproxy_set_header Upgrade $http_upgrade;\r\n    \t        proxy_set_header Connection \'upgrade\';\r\n    \t\tproxy_set_header Host $host;\r\n    \t\tproxy_cache_bypass $http_upgrade;\r\n    \t\tproxy_set_header X-Forwarded-Proto $scheme;\r\n    \t\tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n    \t\tclient_max_body_size 10g;\r\n\t}\r\n\r\n        location /apiex {\r\n                proxy_pass http://127.0.0.1:3002;\r\n                proxy_http_version 1.1;\r\n                proxy_set_header Upgrade $http_upgrade;\r\n                proxy_set_header Connection \'upgrade\';\r\n                proxy_set_header Host $host;\r\n                proxy_cache_bypass $http_upgrade;\r\n                proxy_set_header X-Forwarded-Proto $scheme;\r\n                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n                client_max_body_size 10g;\r\n        }\r\n\r\n\tlocation /directory {\r\n\t\talias /home/ubuntu/directory/recruitment-system;\r\n\t\tautoindex on;\r\n\t\tindex off;\r\n\t\ttry_files $uri $uri/ =404;\r\n\t\tdefault_type text/plain;\r\n\t}\r\n\r\n\r\n\tlocation /socketex {\r\n        proxy_pass http://127.0.0.1:3002;\r\n        proxy_http_version 1.1;\r\n        proxy_set_header Upgrade $http_upgrade;\r\n        proxy_set_header Connection "upgrade";\r\n        proxy_set_header Host $host;\r\n        }\r\n\r\n\r\n\tlocation /socket.io {\r\n        proxy_pass http://127.0.0.1:3001;\r\n        proxy_http_version 1.1;\r\n        proxy_set_header Upgrade $http_upgrade;\r\n        proxy_set_header Connection "upgrade";\r\n        proxy_set_header Host $host;\r\n        }\r\n\r\n\troot /home/ubuntu/recruitment-system/client/dist;\r\n\tindex index.html;\r\n\r\n\tlocation / {\r\n\t\ttry_files $uri $uri/ /index.html;\r\n\r\n\t\tlocation ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {\r\n                 expires 30d;\r\n                 access_log off;\r\n                 add_header Cache-Control "public, max-age=2592000";\r\n                }\r\n\r\n\t\tadd_header Cache-Control "no-store, no-cache, must-revalidate";\r\n\t\texpires 0;\r\n\t}\r\n\r\n\tlocation /experimental {\r\n\r\n\t\talias /home/ubuntu/test/recruitment-system/client/dist;\r\n\t        try_files $uri $uri/ /experimental/index.html;\r\n\r\n\t\tlocation ~* ^/experimental/(.+\\.(js|css|png|jpg|jpeg|gif|ico|svg))$ {\r\n                  expires 30d;\r\n                  access_log off;\r\n                  add_header Cache-Control "public, max-age=2592000";\r\n                  alias /home/ubuntu/test/recruitment-system/client/dist/$1;  # Ensure this points to the correct directory\r\n                }\r\n\r\n                add_header Cache-Control "no-store, no-cache, must-revalidate";\r\n\t}\r\n\r\n\r\n        location /community {\r\n\r\n                alias /home/ubuntu/test/recruitment-system/client-community/dist;\r\n                try_files $uri $uri/ /community/index.html;\r\n\r\n                location ~* ^/community/(.+\\.(js|css|png|jpg|jpeg|gif|ico|svg))$ {\r\n                  expires 30d;\r\n                  access_log off;\r\n                  add_header Cache-Control "public, max-age=2592000";\r\n                  alias /home/ubuntu/test/recruitment-system/client-community/dist/$1;  # Ensure this points to the correct directory\r\n                }\r\n\r\n                add_header Cache-Control "no-store, no-cache, must-revalidate";\r\n        }\r\n\r\n\r\n    listen 443 ssl; # managed by Certbot\r\n    ssl_certificate /etc/letsencrypt/live/recruitment.connextglobal.com/fullchain.pem; # managed by Certbot\r\n    ssl_certificate_key /etc/letsencrypt/live/recruitment.connextglobal.com/privkey.pem; # managed by Certbot\r\n    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot\r\n    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot\r\n\r\n}\r\nserver {\r\n    if ($host = recruitment.connextglobal.com) {\r\n        return 301 https://$host$request_uri;\r\n    } # managed by Certbot\r\n\r\n\r\n\tlisten 80;\r\n\tserver_name recruitment.connextglobal.com;\r\n    return 404; # managed by Certbot\r\n\r\n\r\n}\r\n\n'})}),"\n",(0,i.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsxs)(n.p,{children:["This Nginx configuration is structured to serve multiple applications efficiently, ensuring secure API handling, WebSocket support, static file caching, and automatic SSL management. Modifications should be tested with ",(0,i.jsx)(n.code,{children:"nginx -t"})," before applying changes."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);